<html>

<head>
    <title>Accept.js RN Bridge (Test)</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="https://jstest.authorize.net/v1/Accept.js" charset="utf-8"></script>
</head>

<body>
    <script>
        // immediately invoked function
        (function iffy() {
            function sendResult(result) {
                if (!window.ReactNativeWebView) return
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'result',
                    data: result
                }))
            }

            function sendError(message) {
                if (!window.ReactNativeWebView) return
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'error',
                    message
                }))
            }

            function log(msg) {
                if (!window.ReactNativeWebView) return
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'log',
                    message: msg
                }))
            }

            log('init https://jstest.authorize.net/v1/Accept.js')
            log('!!window.ReactNativeWebView', !!window.ReactNativeWebView)

            var promiseChain = Promise.resolve()
            function init() {
                log('init called')
                function messageHandler(e) {
                    log("Message received: " + e.data)
                    var message
                    try {
                        message = JSON.parse(e.data)
                    }
                    catch (err) {
                        log("Failed to parse RN message: " + err)
                        sendError(`${err.message}: ${err.stack}`)
                        return
                    }

                    promiseChain.then(function acceptWrapper() {
                        promiseChain = new Promise(function dispatchToAccept(resolve) {
                            if (message.throwError) {
                                throw new Error('simulated error')
                            }
                            // call out to Accept.js
                            window.Accept.dispatchData(message, resolve)
                        }).then(function onDispatchResult(result) {
                            // log(JSON.stringify(result));
                            sendResult(result)
                        }).catch(function onDispatchError(err) {
                            // log('rnBridge send failed ' + e.message);
                            sendError(`${err.message}: ${err.stack}`)
                        })
                    })
                }

                // https://github.com/react-native-webview/react-native-webview/issues/356#issuecomment-467430141
                // use window for iOS
                // window.addEventListener('message', messageHandler)
                // use document for Android
                // document.addEventListener('message', messageHandler)
                var isUIWebView = /\(ip.*applewebkit(?!.*(version|crios))/i.test(navigator.userAgent)
                var receiver = isUIWebView ? window : document
                log("isUIWebView: " + isUIWebView)
                receiver.addEventListener('message', messageHandler);
            }
            init()
        }())
    </script>
</body>

</html>