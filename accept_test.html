<html>

<head>
    <title>Accept</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="https://jstest.authorize.net/v1/Accept.js" charset="utf-8"></script>
</head>

<body>
    <script>
        // self-executing function
        (function () {
            var sendResult = function (result) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'result',
                    data: result
                }))
            }

            var sendError = function (message) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'error',
                    message
                }))
            }

            var log = function (msg) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'log',
                    message: msg
                }))
            }

            log('init https://jstest.authorize.net/v1/Accept.js')

            var promiseChain = Promise.resolve()
            var init = function () {
                window.addEventListener('message', function (e) {
                    log("Message received: " + e.data)
                    var message
                    try {
                        message = JSON.parse(e.data)
                    }
                    catch (err) {
                        log("Failed to parse RN message: " + err)
                        sendError(`${err.message}: ${JSON.stringify(err)}`)
                        return;
                    }

                    promiseChain.then(function () {
                        promiseChain = new Promise(function (resolve) {
                            if (message.throwError) {
                                throw new Error('simulated error')
                            }
                            // call out to Accept.js
                            window.Accept.dispatchData(message, resolve);
                        }).then(function (result) {
                            // log(JSON.stringify(result));
                            sendResult(result)
                        }).catch(function (err) {
                            // log('rnBridge send failed ' + e.message);
                            sendError(`${err.message}: ${JSON.stringify(err)}`)
                        });
                    });
                });
            };
            init();
        }());
    </script>
</body>

</html>